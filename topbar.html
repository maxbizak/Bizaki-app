<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BIZAKI Topbar</title>

    <style>
        :root {
            --bg: #0b0f17;
            --bg2: #0e1422;
            --text: #d6deff;
            --muted: #8ea0c9;
            --line: rgba(255,255,255,.07);
            --btn: rgba(255,255,255,.06);
            --btnHover: rgba(255,255,255,.10);
            --danger: rgba(255,72,72,.18);
            --dangerHover: rgba(255,72,72,.28);
            --pill: rgba(255,255,255,.08);
            --pill2: rgba(255,255,255,.12);
            --accent: rgba(120,180,255,.18);
            --accentHover: rgba(120,180,255,.28);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--text);
            user-select: none;
            overflow: hidden;
        }

        .bar {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(180deg, var(--bg2), var(--bg));
            -webkit-app-region: drag;
        }

        .left, .center, .right {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
        }

        .center {
            justify-content: center;
            flex: 1;
            min-width: 0;
            pointer-events: none;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: none;
            opacity: .95;
        }

        .logo {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            background: rgba(255,255,255,.08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

            .logo img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .title {
            font-weight: 700;
            letter-spacing: .12em;
            font-size: 12px;
            color: var(--text);
            opacity: .95;
        }

        .statusWrap {
            -webkit-app-region: no-drag;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pill {
            display: none; /* показываем только когда есть состояние */
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--pill);
            border: 1px solid var(--line);
            font-size: 12px;
            color: var(--muted);
            max-width: 360px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

            .pill[data-visible="true"] {
                display: flex;
            }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,.35);
            flex: 0 0 auto;
        }

        .pill strong {
            color: var(--text);
            font-weight: 600;
        }

        .restartBtn {
            display: none;
            -webkit-app-region: no-drag;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: var(--accent);
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

            .restartBtn:hover {
                background: var(--accentHover);
            }

        .btn {
            -webkit-app-region: no-drag;
            width: 42px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: var(--btn);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .btn:hover {
                background: var(--btnHover);
            }

            .btn.close {
                background: var(--danger);
            }

                .btn.close:hover {
                    background: var(--dangerHover);
                }

        .ico {
            width: 14px;
            height: 14px;
            display: block;
            opacity: .9;
        }
    </style>
</head>

<body>
    <div class="bar">
        <div class="left">
            <!-- сюда можно позже добавить “назад/вперёд”, если нужно -->
        </div>

        <div class="center">
            <div class="brand">
                <div class="logo">
                    <img src="./logo.png" alt="B" />
                </div>
                <div class="title">BIZAKI</div>
            </div>
        </div>

        <div class="right">
            <div class="statusWrap">
                <div id="pill" class="pill" data-visible="false" title="">
                    <span class="dot" id="dot"></span>
                    <span id="pillText">—</span>
                </div>
                <button id="restartBtn" class="restartBtn">Restart to update</button>
            </div>

            <button class="btn" id="minBtn" title="Свернуть">
                <svg class="ico" viewBox="0 0 10 10" fill="none">
                    <path d="M2 5.5h6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" />
                </svg>
            </button>

            <button class="btn" id="maxBtn" title="Развернуть">
                <svg class="ico" id="maxIcon" viewBox="0 0 10 10" fill="none">
                    <path d="M2.2 2.2h5.6v5.6H2.2z" stroke="currentColor" stroke-width="1.1" />
                </svg>
            </button>

            <button class="btn close" id="closeBtn" title="Закрыть">
                <svg class="ico" viewBox="0 0 10 10" fill="none">
                    <path d="M2.2 2.2l5.6 5.6M7.8 2.2L2.2 7.8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        const pill = document.getElementById("pill");
        const pillText = document.getElementById("pillText");
        const restartBtn = document.getElementById("restartBtn");
        const minBtn = document.getElementById("minBtn");
        const maxBtn = document.getElementById("maxBtn");
        const closeBtn = document.getElementById("closeBtn");

        const setPill = (visible, text, title = "") => {
            pill.dataset.visible = visible ? "true" : "false";
            pillText.textContent = text || "";
            pill.title = title || "";
        };

        const showRestart = (show) => {
            restartBtn.style.display = show ? "inline-flex" : "none";
        };

        // window controls
        minBtn.addEventListener("click", () => window.bizaki.min());
        maxBtn.addEventListener("click", () => window.bizaki.max());
        closeBtn.addEventListener("click", () => window.bizaki.close());

        restartBtn.addEventListener("click", () => {
            // установка скачанного обновления + перезапуск
            window.bizaki.installUpdate();
        });

        // maximize icon state (optional)
        window.bizaki.onMaximized((isMaximized) => {
            maxBtn.title = isMaximized ? "Восстановить" : "Развернуть";
        });

        // update status from main.js
        window.bizaki.onUpdateStatus((p) => {
            // p = { state: "checking" | "available" | "none" | "downloading" | "ready" | "error" | "dev", ... }
            if (!p || !p.state) return;

            if (p.state === "dev") {
                setPill(true, "Dev mode: updates off", p.message || "");
                showRestart(false);
                return;
            }

            if (p.state === "checking") {
                setPill(true, "Checking updates…");
                showRestart(false);
                return;
            }

            if (p.state === "none") {
                // можно скрыть полностью, чтобы не мешало
                setPill(false, "");
                showRestart(false);
                return;
            }

            if (p.state === "available") {
                const v = p.info?.version ? `v${p.info.version}` : "update";
                setPill(true, `Update available ${v}`);
                showRestart(false);
                return;
            }

            if (p.state === "downloading") {
                const pct = (typeof p.percent === "number") ? `${Math.floor(p.percent)}%` : "";
                setPill(true, `Downloading… ${pct}`);
                showRestart(false);
                return;
            }

            if (p.state === "ready") {
                const v = p.info?.version ? `v${p.info.version}` : "";
                setPill(true, `Update ready ${v}`);
                showRestart(true);
                return;
            }

            if (p.state === "error") {
                setPill(true, "Update error", p.message || "");
                showRestart(false);
                return;
            }
        });
    </script>
</body>
</html>
